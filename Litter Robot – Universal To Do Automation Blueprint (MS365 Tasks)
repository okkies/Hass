blueprint:
  name: Litter Robot Manager - DEFINITIEVE VERSIE
  description: |
    ‚úÖ Correcte todo services (update_item, remove_item)
    ‚úÖ Juiste response variable toegang 
    ‚úÖ Werkt met Todoist EN lokale lijsten
    ‚úÖ Extra triggers voor startup en periodieke checks
    ‚úÖ Volledig getest met Home Assistant 2024.x/2025.x
  domain: automation
  input:
    waste_sensor:
      name: Waste Drawer Sensor
      description: Poeplade niveau sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_waste_drawer

    litter_sensor:
      name: Litter Level Sensor
      description: Korrels hopper niveau sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_litter_level

    status_sensor:
      name: Status Code Sensor
      description: Status code sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_status_code

    todo_list:
      name: Todo List
      description: Todoist lijst (todo.inbox) of lokale lijst (todo.shopping_list)
      selector:
        entity:
          domain: todo
      default: todo.inbox

    use_todoist:
      name: Use Todoist
      description: ON voor Todoist (completed status), OFF voor lokale lijst (remove)
      selector:
        boolean:
      default: true

    waste_warning:
      name: Waste Warning Level (%)
      default: 70
      selector:
        number:
          min: 50
          max: 89
          step: 5
          unit_of_measurement: "%"

    waste_critical:
      name: Waste Critical Level (%)
      default: 85
      selector:
        number:
          min: 60
          max: 100
          step: 5
          unit_of_measurement: "%"

    litter_warning:
      name: Litter Warning Level (%)
      default: 30
      selector:
        number:
          min: 10
          max: 50
          step: 5
          unit_of_measurement: "%"

    litter_critical:
      name: Litter Critical Level (%)
      default: 15
      selector:
        number:
          min: 5
          max: 30
          step: 5
          unit_of_measurement: "%"

mode: single
max_exceeded: silent

variables:
  waste_sensor: !input waste_sensor
  litter_sensor: !input litter_sensor
  status_sensor: !input status_sensor
  todo_list: !input todo_list
  is_todoist: !input use_todoist
  waste_warn: !input waste_warning
  waste_crit: !input waste_critical
  litter_warn: !input litter_warning
  litter_crit: !input litter_critical

trigger:
  # Waste level triggers
  - platform: state
    entity_id: !input waste_sensor
    id: waste_changed
    for:
      seconds: 5

  # Litter level triggers
  - platform: state
    entity_id: !input litter_sensor
    id: litter_changed
    for:
      seconds: 5

  # Status triggers
  - platform: state
    entity_id: !input status_sensor
    id: status_changed
    for:
      seconds: 3

  # Check bij Home Assistant start
  - platform: homeassistant
    event: start
    id: startup_check

  # Periodieke check elke 4 uur
  - platform: time_pattern
    hours: "/4"
    id: periodic_check

  # Dagelijkse ochtend check
  - platform: time
    at: "09:00:00"
    id: morning_check

action:
  # Get current values
  - variables:
      waste_level: "{{ states(waste_sensor) | int(0) }}"
      litter_level: "{{ states(litter_sensor) | int(0) }}"
      current_status: "{{ states(status_sensor) }}"

  # Bij startup/periodic/morning checks, voer alle checks uit
  - choose:
      - conditions:
          - condition: trigger
            id:
              - startup_check
              - periodic_check
              - morning_check
        sequence:
          - variables:
              check_all: true
    default:
      - variables:
          check_all: false

  # WASTE MANAGEMENT
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: waste_changed
              - condition: template
                value_template: "{{ check_all }}"
        sequence:
          - service: todo.get_items
            target:
              entity_id: "{{ todo_list }}"
            data:
              status: needs_action
            response_variable: active_tasks

          - repeat:
              for_each: "{{ active_tasks[todo_list]['items'] | default([]) }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: >
                            {{ 'Poeplade' in repeat.item.summary or
                               'poeplade' in repeat.item.summary or
                               'Waste' in repeat.item.summary }}
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ is_todoist }}"
                              sequence:
                                - service: todo.update_item
                                  target:
                                    entity_id: "{{ todo_list }}"
                                  data:
                                    item: "{{ repeat.item.summary }}"
                                    status: "completed"
                                  continue_on_error: true
                          default:
                            - service: todo.remove_item
                              target:
                                entity_id: "{{ todo_list }}"
                              data:
                                item: "{{ repeat.item.summary }}"
                              continue_on_error: true

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ waste_level >= waste_crit }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "üî¥ Polly's poeplade VOL - URGENT! ({{ waste_level }}%)"
                      due_date: "{{ now().date() }}"
                      description: |
                        De poeplade is {{ waste_level }}% vol!
                        Status: {{ current_status }}
                        Korrels: {{ litter_level }}%

                        Polly kan straks niet meer poepen!
              - conditions:
                  - condition: template
                    value_template: "{{ waste_level >= waste_warn and waste_level < waste_crit }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "üü° Polly's poeplade bijna vol ({{ waste_level }}%)"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"

  # LITTER MANAGEMENT
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: litter_changed
              - condition: template
                value_template: "{{ check_all }}"
        sequence:
          - service: todo.get_items
            target:
              entity_id: "{{ todo_list }}"
            data:
              status: needs_action
            response_variable: active_tasks

          - repeat:
              for_each: "{{ active_tasks[todo_list]['items'] | default([]) }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: >
                            {{ 'Korrels' in repeat.item.summary or
                               'korrels' in repeat.item.summary or
                               'Litter' in repeat.item.summary or
                               'Kattenbakvulling' in repeat.item.summary }}
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ is_todoist }}"
                              sequence:
                                - service: todo.update_item
                                  target:
                                    entity_id: "{{ todo_list }}"
                                  data:
                                    item: "{{ repeat.item.summary }}"
                                    status: "completed"
                                  continue_on_error: true
                          default:
                            - service: todo.remove_item
                              target:
                                entity_id: "{{ todo_list }}"
                              data:
                                item: "{{ repeat.item.summary }}"
                              continue_on_error: true

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ litter_level <= litter_crit }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "üî¥ Kattenbakvulling BIJNA OP! ({{ litter_level }}%)"
                      due_date: "{{ now().date() }}"
                      description: |
                        Hopper heeft nog maar {{ litter_level }}% korrels!
                        Nieuwe zak kopen VANDAAG!
              - conditions:
                  - condition: template
                    value_template: "{{ litter_level <= litter_warn and litter_level > litter_crit }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "üü° Korrels worden minder ({{ litter_level }}%)"
                      due_date: "{{ (now() + timedelta(days=3)).date() }}"

  # STATUS MANAGEMENT
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: status_changed
              - condition: template
                value_template: "{{ check_all }}"
        sequence:
          - service: todo.get_items
            target:
              entity_id: "{{ todo_list }}"
            data:
              status: needs_action
            response_variable: active_tasks

          - repeat:
              for_each: "{{ active_tasks[todo_list]['items'] | default([]) }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: >
                            {{ 'Status:' in repeat.item.summary or
                               '‚ö†Ô∏è' in repeat.item.summary or
                               'üîß' in repeat.item.summary or
                               '‚≠ï' in repeat.item.summary or
                               'üî¥ Status:' in repeat.item.summary or
                               'üü° Status:' in repeat.item.summary or
                               '‚ùì Status:' in repeat.item.summary }}
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ is_todoist }}"
                              sequence:
                                - service: todo.update_item
                                  target:
                                    entity_id: "{{ todo_list }}"
                                  data:
                                    item: "{{ repeat.item.summary }}"
                                    status: "completed"
                                  continue_on_error: true
                          default:
                            - service: todo.remove_item
                              target:
                                entity_id: "{{ todo_list }}"
                              data:
                                item: "{{ repeat.item.summary }}"
                              continue_on_error: true

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ current_status in ['rdy', 'ccc', 'ccp', 'idle'] }}"
                sequence: []
              - conditions:
                  - condition: template
                    value_template: "{{ current_status not in ['rdy', 'ccc', 'ccp', 'idle'] }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: >
                        {% if current_status == 'df2' %}
                          üî¥ Status: Drawer FULL - Unit gestopt!
                        {% elif current_status == 'df1' %}
                          üü° Status: Drawer bijna vol
                        {% elif current_status in ['csf', 'csi', 'cst'] %}
                          ‚ö†Ô∏è Status: Sensor probleem ({{ current_status }})
                        {% elif current_status == 'br' %}
                          üîß Status: Deksel eraf!
                        {% elif current_status == 'off' %}
                          ‚≠ï Status: Unit staat UIT
                        {% else %}
                          ‚ùì Status: {{ current_status }}
                        {% endif %}
                      due_date: "{{ now().date() }}"
