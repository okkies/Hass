blueprint:
  name: Polly Poeptroon Manager
  description: Beheert taken voor Polly's kattenbak - maakt ze aan en ruimt ze op
  domain: automation
  input:
    waste_drawer_sensor:
      name: Waste Drawer Sensor
      description: De poeplade sensor
      selector:
        entity:
          filter:
            domain: sensor
      default: sensor.pollies_poeptroon_waste_drawer
    
    litter_level_sensor:
      name: Litter Level Sensor  
      description: De korrels hopper sensor
      selector:
        entity:
          filter:
            domain: sensor
      default: sensor.pollies_poeptroon_litter_level
    
    target_todo_list:
      name: Todo Lijst
      description: Welke todo lijst gebruiken (Shopping List of Inbox)
      selector:
        entity:
          filter:
            domain: todo
      default: todo.inbox

trigger:
  - platform: numeric_state
    entity_id: !input waste_drawer_sensor
    above: 85
    id: waste_high
  
  - platform: numeric_state
    entity_id: !input waste_drawer_sensor
    above: 70
    below: 85
    id: waste_warning
  
  - platform: numeric_state
    entity_id: !input waste_drawer_sensor
    below: 65
    id: waste_normal
  
  - platform: numeric_state
    entity_id: !input litter_level_sensor
    below: 20
    id: litter_critical
  
  - platform: numeric_state
    entity_id: !input litter_level_sensor
    below: 35
    above: 20
    id: litter_warning
  
  - platform: numeric_state
    entity_id: !input litter_level_sensor
    above: 40
    id: litter_normal

condition: []

action:
  - choose:
      # WASTE HIGH
      - conditions:
          - condition: trigger
            id: waste_high
        sequence:
          - service: todo.add_item
            data:
              item: "üî¥ URGENT: Polly's poeplade legen! ({{ trigger.to_state.state }}% vol)"
              due_date: "{{ now().date() }}"
            target:
              entity_id: !input target_todo_list
          
          - service: persistent_notification.create
            data:
              title: "Polly's Poeplade Vol!"
              message: "De poeplade is {{ trigger.to_state.state }}% vol. Direct legen!"
              notification_id: polly_waste_critical
      
      # WASTE WARNING
      - conditions:
          - condition: trigger
            id: waste_warning
        sequence:
          - service: todo.add_item
            data:
              item: "üü° Polly's poeplade bijna vol ({{ trigger.to_state.state }}%)"
              due_date: "{{ (now() + timedelta(days=1)).date() }}"
            target:
              entity_id: !input target_todo_list
      
      # WASTE NORMAL - Clean up tasks
      - conditions:
          - condition: trigger
            id: waste_normal
        sequence:
          - service: persistent_notification.dismiss
            data:
              notification_id: polly_waste_critical
      
      # LITTER CRITICAL
      - conditions:
          - condition: trigger
            id: litter_critical
        sequence:
          - service: todo.add_item
            data:
              item: "üî¥ Kattenbakvulling BIJNA OP! ({{ trigger.to_state.state }}%)"
              due_date: "{{ now().date() }}"
            target:
              entity_id: !input target_todo_list
          
          - service: persistent_notification.create
            data:
              title: "Korrels Bijna Op!"
              message: "Nog maar {{ trigger.to_state.state }}% korrels. Nieuwe zak kopen!"
              notification_id: polly_litter_critical
      
      # LITTER WARNING
      - conditions:
          - condition: trigger
            id: litter_warning
        sequence:
          - service: todo.add_item
            data:
              item: "‚ö†Ô∏è Korrels worden minder ({{ trigger.to_state.state }}%)"
              due_date: "{{ (now() + timedelta(days=3)).date() }}"
            target:
              entity_id: !input target_todo_list
      
      # LITTER NORMAL
      - conditions:
          - condition: trigger
            id: litter_normal
        sequence:
          - service: persistent_notification.dismiss
            data:
              notification_id: polly_litter_critical

mode: single
max_exceeded: silent
