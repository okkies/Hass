blueprint:
  name: Litter Robot Task Manager - Fixed
  description: |
    Automatically manages Litter Robot maintenance tasks.
    Creates tasks when issues occur, removes them when resolved.
    100% compatible with Home Assistant's local todo lists.
  domain: automation
  input:
    waste_sensor:
      name: Waste Drawer Sensor
      description: Select your Litter Robot waste drawer sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_waste_drawer
    
    status_sensor:
      name: Status Code Sensor  
      description: Select your Litter Robot status code sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_status_code
    
    todo_entity:
      name: To-Do List
      description: Select a LOCAL todo list (Shopping List or custom). Todoist won't work!
      selector:
        entity:
          domain: todo
      default: todo.shopping_list
    
    warning_threshold:
      name: Warning Threshold (%)
      description: Create warning task at this waste level
      default: 75
      selector:
        number:
          min: 50
          max: 89
          step: 5
          unit_of_measurement: "%"
    
    critical_threshold:
      name: Critical Threshold (%)
      description: Create critical task at this waste level
      default: 90
      selector:
        number:
          min: 60
          max: 100
          step: 5
          unit_of_measurement: "%"

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input waste_sensor
    id: waste_level_changed
    for:
      seconds: 3
  
  - platform: state
    entity_id: !input status_sensor
    id: status_changed
    for:
      seconds: 3

variables:
  waste_sensor: !input waste_sensor
  status_sensor: !input status_sensor
  todo_list: !input todo_entity
  warning_level: !input warning_threshold
  critical_level: !input critical_threshold

action:
  # Get sensor values
  - variables:
      waste_percent: "{{ states(waste_sensor) | int(0) }}"
      current_status: "{{ states(status_sensor) }}"
      task_prefix: "[LR]"
  
  # Get existing todo items
  - service: todo.get_items
    target:
      entity_id: "{{ todo_list }}"
    data:
      status: needs_action
    response_variable: current_tasks
  
  # HANDLE WASTE LEVEL CHANGES
  - choose:
      - conditions:
          - condition: trigger
            id: waste_level_changed
        sequence:
          # First remove ALL old waste-related tasks
          - repeat:
              for_each: "{{ current_tasks.get('items', []) }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: >
                            {{ task_prefix in repeat.item.summary and 
                               ('Waste' in repeat.item.summary or 'Empty' in repeat.item.summary) }}
                      sequence:
                        - service: todo.remove_item
                          target:
                            entity_id: "{{ todo_list }}"
                          data:
                            item: "{{ repeat.item.summary }}"
                          continue_on_error: true
          
          # Then add the appropriate new task based on level
          - choose:
              # CRITICAL LEVEL (90%+)
              - conditions:
                  - condition: template
                    value_template: "{{ waste_percent >= critical_level }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} üî¥ Empty Waste Drawer NOW! ({{ waste_percent }}% full)"
                      due_date: "{{ now().date() }}"
              
              # WARNING LEVEL (75-89%)
              - conditions:
                  - condition: template
                    value_template: "{{ waste_percent >= warning_level and waste_percent < critical_level }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} üü° Empty Waste Drawer Soon ({{ waste_percent }}% full)"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # NORMAL LEVEL (<75%) - No action needed, tasks already removed
      
      # HANDLE STATUS CHANGES
      - conditions:
          - condition: trigger
            id: status_changed
        sequence:
          # First remove ALL old status tasks
          - repeat:
              for_each: "{{ current_tasks.get('items', []) }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: >
                            {{ task_prefix in repeat.item.summary and 
                               'Status:' in repeat.item.summary }}
                      sequence:
                        - service: todo.remove_item
                          target:
                            entity_id: "{{ todo_list }}"
                          data:
                            item: "{{ repeat.item.summary }}"
                          continue_on_error: true
          
          # Then add task if status indicates a problem
          - choose:
              # Ready status - no task needed
              - conditions:
                  - condition: template
                    value_template: "{{ current_status in ['rdy', 'ccc', 'ccp', 'cd'] }}"
                sequence: []
              
              # Drawer Full
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'df2' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} üî¥ Status: Drawer Full - Unit Stopped"
                      due_date: "{{ now().date() }}"
              
              # Drawer Almost Full
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'df1' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} üü° Status: Drawer Almost Full"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # Cat Sensor Issues
              - conditions:
                  - condition: template
                    value_template: "{{ current_status in ['csf', 'csi', 'cst'] }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} ‚ö†Ô∏è Status: Cat Sensor Issue ({{ current_status }})"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # Bonnet Removed
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'br' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} ‚ö†Ô∏è Status: Bonnet Removed"
                      due_date: "{{ now().date() }}"
              
              # Unit Off
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'off' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} ‚≠ï Status: Unit is Off"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # Unit Paused
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'p' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} ‚è∏Ô∏è Status: Unit Paused"
                      due_date: "{{ (now() + timedelta(days=2)).date() }}"
              
              # Pinch Detect
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'pd' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} üîÑ Status: Pinch Detect"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # Other error states
              - conditions:
                  - condition: template
                    value_template: "{{ current_status not in ['rdy', 'ccc', 'ccp', 'cd', 'df1', 'df2', 'csf', 'csi', 'cst', 'br', 'off', 'p', 'pd'] }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "{{ task_prefix }} ‚ùì Status: {{ current_status }}"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
