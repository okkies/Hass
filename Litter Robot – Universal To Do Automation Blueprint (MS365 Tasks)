blueprint:
  name: Litter Robot Task Manager (Simple)
  description: |
    Manages Litter Robot maintenance tasks - creates when needed, removes when fixed.
    Compatible with Home Assistant local todo lists.
  domain: automation
  input:
    waste_sensor:
      name: Waste Drawer Sensor
      description: Your Litter Robot waste drawer level sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_waste_drawer
    
    status_sensor:
      name: Status Code Sensor
      description: Your Litter Robot status code sensor
      selector:
        entity:
          domain: sensor
      default: sensor.pollies_poeptroon_status_code
    
    todo_entity:
      name: To-Do List
      description: Select a LOCAL todo list (NOT Todoist - it's read-only!)
      selector:
        entity:
          domain: todo
      default: todo.shopping_list
    
    warning_threshold:
      name: Warning Level (%)
      description: Warning when waste drawer reaches this
      default: 75
      selector:
        number:
          min: 50
          max: 89
          step: 5
          unit_of_measurement: "%"
    
    critical_threshold:
      name: Critical Level (%)
      description: Critical when waste drawer reaches this
      default: 90
      selector:
        number:
          min: 60
          max: 100
          step: 5
          unit_of_measurement: "%"

mode: single
max_exceeded: silent

variables:
  waste_sensor: !input waste_sensor
  status_sensor: !input status_sensor
  todo_list: !input todo_entity
  warning_level: !input warning_threshold
  critical_level: !input critical_threshold

trigger:
  - platform: state
    entity_id: !input waste_sensor
    id: waste_changed
  
  - platform: state
    entity_id: !input status_sensor
    id: status_changed

action:
  # Get current waste level and status
  - variables:
      waste_percent: "{{ states(waste_sensor) | int(0) }}"
      current_status: "{{ states(status_sensor) }}"
  
  # Get existing tasks to check/remove
  - service: todo.get_items
    target:
      entity_id: "{{ todo_list }}"
    data:
      status: needs_action
    response_variable: existing_tasks
  
  # Process waste level changes
  - if:
      - condition: trigger
        id: waste_changed
    then:
      # Remove old waste tasks first
      - repeat:
          for_each: "{{ existing_tasks.get('items', []) }}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ '[LR]' in repeat.item.summary and 'Waste' in repeat.item.summary }}"
              then:
                - service: todo.remove_item
                  target:
                    entity_id: "{{ todo_list }}"
                  data:
                    item: "{{ repeat.item.summary }}"
                  continue_on_error: true
      
      # Add appropriate new task based on level
      - choose:
          # Critical level
          - conditions:
              - condition: template
                value_template: "{{ waste_percent >= critical_level }}"
            sequence:
              - service: todo.add_item
                target:
                  entity_id: "{{ todo_list }}"
                data:
                  item: "[LR] ðŸ”´ Empty Waste Drawer - CRITICAL ({{ waste_percent }}%)"
                  due_date: "{{ now().date() }}"
          
          # Warning level
          - conditions:
              - condition: template
                value_template: "{{ waste_percent >= warning_level and waste_percent < critical_level }}"
            sequence:
              - service: todo.add_item
                target:
                  entity_id: "{{ todo_list }}"
                data:
                  item: "[LR] ðŸŸ¡ Empty Waste Drawer - Warning ({{ waste_percent }}%)"
                  due_date: "{{ (now() + timedelta(days=1)).date() }}"
  
  # Process status changes
  - if:
      - condition: trigger
        id: status_changed
    then:
      # Remove old status tasks
      - repeat:
          for_each: "{{ existing_tasks.get('items', []) }}"
          sequence:
            - if:
                - condition: template
                  value_template: "{{ '[LR]' in repeat.item.summary and 'Status' in repeat.item.summary }}"
              then:
                - service: todo.remove_item
                  target:
                    entity_id: "{{ todo_list }}"
                  data:
                    item: "{{ repeat.item.summary }}"
                  continue_on_error: true
      
      # Add task for problem statuses
      - if:
          - condition: template
            value_template: "{{ current_status not in ['rdy', 'ccc', 'ccp'] }}"
        then:
          - choose:
              # Drawer full statuses
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'df2' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "[LR] ðŸ”´ Status: Drawer Full - Unit Stopped!"
                      due_date: "{{ now().date() }}"
              
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'df1' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "[LR] ðŸŸ¡ Status: Drawer Almost Full"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # Sensor issues
              - conditions:
                  - condition: template
                    value_template: "{{ current_status in ['csf', 'csi'] }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "[LR] âš ï¸ Status: Cat Sensor Issue"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              # Other issues
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'br' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "[LR] âš ï¸ Status: Bonnet Removed"
                      due_date: "{{ now().date() }}"
              
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'off' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "[LR] â­• Status: Unit is Off"
                      due_date: "{{ (now() + timedelta(days=1)).date() }}"
              
              - conditions:
                  - condition: template
                    value_template: "{{ current_status == 'p' }}"
                sequence:
                  - service: todo.add_item
                    target:
                      entity_id: "{{ todo_list }}"
                    data:
                      item: "[LR] â¸ï¸ Status: Unit Paused"
                      due_date: "{{ (now() + timedelta(days=2)).date() }}"
